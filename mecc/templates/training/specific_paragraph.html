{% extends "base.html" %} {% load i18n %} {% load crispy_forms_tags %} {% load staticfiles %}
{% block page-header %} {% trans 'Fiche Formation' %} {% endblock %}

{% block app_content %}
<ul class="nav nav-tabs" style="margin-bottom:1em">
    <li><a href="{%if training%}{% url 'training:edit' training.pk%}{%else%}#{%endif%}">{% trans "Général" %}</a></li>
    <li class="active"><a href="{%if training%}{% url 'training:edit_rules' training.pk%}{%else%}#{%endif%}">{% trans "Règles" %}</a></li>
    <li><a href="#">{% trans "Tableau MECC" %}</a></li>
</ul>
<h2 class="title-modal" style="font-weight: bold;">
    {% trans 'Gestion des dérogations et alinéas de composante'%}
</h2>
<div class="disp-flex dir-col has-bottom-border">
    <div class=" parent disp-flex ">
        <div class="item-80 dir-col">
            <div class="">
                {% trans "Intitulé de la formation: "%}
            </div>
            <div class="">
                <strong>{{training.label}}</strong>
            </div>
        </div>
        <div class="item-20 disabled dir-col">
            <div >
                {% trans "En service:"%} {%if training.is_used%} ☑ {%else%} ☐{%endif%}
            </div>
            <div >
                {% trans "Régime:"%} {{training.get_MECC_type_display}}
            </div>
            <div >
                {{training.get_session_type_display}}

            </div>
        </div>
    </div>
    <div class="item-80 disp-flex" style="margin-bottom:1em;">
        <div class="item-20">
            {% trans "ID règle (auto) : " %} {{rule.n_rule | stringformat:"05d"}}
        </div>
        <div class="item-35">
            {% trans "Année universitaire : " %} {{rule.code_year}}/{{rule.code_year|add:'1'}}
        </div>
        <div class="item-45 bold">
            {{rule.label}}
        </div>
    </div>
</div>
<div class="training-rules">
    <h2 class="title-block" style="font-weight: bold;">
        {% trans 'Alinéas courants'%}
    </h2>
    <div class="">
        {# TODO: dev#}
</div>
    {% include "training/rule_preview.html"%}

    <style media="screen">

    table {
      display: flex;
      flex-flow: column;
      height: 100%;
      width: 100%;
    }
    table thead {
      /* head takes the height it requires,
      and it's not scaled when table is resized */
      flex: 0 0 auto;
      width: calc(100% - 0.9em);
    }
    table tbody {
      /* body takes all the remaining available space */
      flex: 1 1 auto;
      display: block;
      overflow: auto;
      max-height: 50vh;

    }
    table tbody tr {
      width: 100%;
    }
    table thead,
    table tbody tr {
      display: table;
      table-layout: fixed;
    }
    </style>

    <script type="text/javascript">
        function detail_rule(id){
            $.ajax({
                url: "{% url 'rules:details_rule'%}",
                type: "POST",
                data: {
                    val: id,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(data){
                    document.getElementById('year').innerHTML = data.year
                    document.getElementById('title-preview').innerHTML = data.title
                    document.getElementById('preview-rules').getElementsByTagName('tbody')[0].innerHTML = ''
                    for (i=0; i < data.paragraphs.length; i++){
                        var tableRef = document.getElementById('preview-rules').getElementsByTagName('tbody')[0];
                        var newRow   = tableRef.insertRow(tableRef.rows.length);
                        newRow.style.marginTop = '1em';
                        newRow.style.marginBottom = '1em';
                        var cell0  = newRow.insertCell(0);
                        var cell1  = newRow.insertCell(1);
                        var cell2  = newRow.insertCell(2);
                        cell0.style.width = '10%';
                        cell0.style.textAlign = "center"
                        cell1.style.width = '70%';
                        cell2.style.width = '20%';
                        cell0.innerHTML = data.paragraphs[i].alinea;
                        cell1.innerHTML = data.paragraphs[i].text;
                        if (data.paragraphs[i].is_derog === true){
                            cell2.className += ' border-left disabled italic td-centered';
                            cell2.innerHTML = "Dérogation possible"
                        }
                        if (data.paragraphs[i].is_cmp === true){
                            cell2.className += ' border-left disabled italic td-centered';
                            cell2.innerHTML = "Alinéa de composante possible"
                        }
                    }


                }
            });
            $('#preview').modal('show');

        }
    </script>
{%endblock%}
