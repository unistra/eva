{% extends "base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}

{% load staticfiles %}

{% block page-header %}
{% trans 'Fiche Formation' %}

{% endblock %}


{% block app_content %}
    <ul class="nav nav-tabs" style="margin-bottom:1em">
        <li class="active"><a href="{%if object%}{% url 'training:edit' object.pk%}{%else%}#{%endif%}">{% trans "Général" %}</a></li>

        <li><a href={%if object%}"{% url 'training:edit_rules' object.pk%}" {%else%}"#" class="disabled"{%endif%}>{% trans "Règles" %}</a></li>
        <li><a href={%if object%}"#" {%else%}"#" class="disabled"{%endif%}>{% trans "Tableau MECC" %}</a></li>
    </ul>
  <div class="disp-flex">
        <form action="" method="post" class="border-right training-form-1" id="training_form">
            {%crispy form%}
            {%if can_edit%}
            {% include "training/form/add_cmp.html" %}
            {% else %}
            <label style="display: inline-block;width:100%" > {% trans "Composantes" %}<span class="asteriskField">*</span>
                <span class="pull-right">porteuse</span>
            </label>
            <table class = "table " id='degreeTable'>

               <tbody class="overflow" id='tbodyCmp'>
              {% for e in object.institutes.all%}
              <tr id='row-{{e.id}}'>
                 <td style="width: 100%" >{{e.label}}
                 </td>
                 <td style="width: 5% " class="td-centered"> <input disabled='disabled' type="radio" name="supply" value="{{e.code}}" {%if e.code == object.supply_cmp%} checked="checked"{%endif%}>
                 </td>

              </tr>
              {%endfor%}

               </tbody>
           </table>


            {%endif%}
                <button name="stay" onclick="_isEdited = false;"class="btn-primary btn btn-sm pull-right" id="stay" type="Submit">{% trans "Valider" %}</button>

        </form>
        <div class="training-form-validate training-form-1 {%if not validation_form%}grey {%endif%}">
            <h2 class="title-block">{% trans "Étapes de validation" %} {{disp_current_year}}</h2></br>
           <div class="form-group">
              <label>
              {% trans "Etat d'avancement Saisie des règles" %}</label>
              <div> <input class="form-control" disabled="true"> </div>
           </div>
           <div class="form-group">
              <label>
              {% trans "Etat d'avancement Saisie Tableau MECC" %}</label>
              <div> <input class="form-control" disabled="true"> </div>
           </div>
           <div class="form-group">
              <label>
              {% trans "Date de validation en Conseil de Composante" %}</label>
              <div> <input class="form-control" disabled="true"> </div>
           </div>
           <div class="form-group">
              <label>
              {% trans "Date Réserve DES" %}</label>
              <div> <input class="form-control" disabled="true"> </div>
           </div>
           <div class="form-group">
              <label>
              {% trans "Date Visa DES" %}</label>
              <div> <input class="form-control" disabled="true"> </div>
           </div>
           <div class="form-group fill-space">
              <label>
              {% trans "Date de validation en CFVU" %}</label>
              <div> <input class="form-control" disabled="true"> </div>
           </div>
           <div>
               <span id="input_progress"></span>
           </div>
           <div class="has-top-border margin-top-auto" {% if object %}style="color:black">
               {% if can_edit  %}
               {% include "training/form/add_respform.html" %}
               {% else %}
               <div class="f-1" style="width:100%">
                   <label style="display: inline-block;width:100%" > {% trans "Responsables de formation" %}
                   </label>

               </div>

               {%if object.resp_formations%}
                   <table class="table" id="respformtable">


                     <tbody class="overflow" id='repsformtbody'>

                     {% for e in object.resp_formations.all %}

                     <tr>
                       <td width=42.5% class="v-align-m">{{e.user.last_name}}</td>
                       <td width="42.5%" class="v-align-m">{{e.user.first_name}}</td>
                       <td width="10%" class="v-align-m">{{e.cmp}}</td>
                       <td width="5%" class="v-align-m">
                           <div class="" action="{% url 'training:process_resp'%}" method="post">
                               <div class="hidden" hidden >
                                   {% csrf_token %}

                                       <input type="text" name="formation"  value="{{object.id}}" readonly>
                                       <input type="text" name="username"  readonly value="{{e.user.username}}">

                                   </div>

                           </div>


                       </td>
                     </tr>
                     {% endfor %}
                   </tbody>
                   </table>
               {% else %}
               <div class="td-centered padding-1">
                   {% trans "PAS DE RESPONSABLE DE FORMATION" %}
               </div>
               {%endif%}
               {% endif %}
               {% else %}>
               <label style="display: inline-block;width:100%" > {% trans "Responsables de formation" %}
                   <br><span class="padding-1">{% trans "AUCUN" %}</span>

               {%endif%}
           </div>
        </div>
 </div>
 <div class="buttons_list has-top-border" style="margin-top:1em;">
 <a href=
 {% if request.session.visited_cmp in 'RESPFORM'%}"{% url 'training:list_resp' %}"
 {%elif request.session.visited_cmp %}"{% url 'training:list' request.session.visited_cmp %}"
 {% else %}"{%url 'training:list_all' %}"
 {% endif %} class="btn-primary btn btn-sm btn-1">{% trans "Fermer la fiche" %}</a>
 <button name="new_training" class="btn-primary btn btn-sm" id="new_training" type="Submit" form='training_form'>{% trans "Créer une nouvelle formation" %}</button>
</div>

<style media="screen">
    .training-form-validate> .form-group:not(:first-child){
        max-width: 100%;
    }
    #div_id_is_used, #div_id_MECC_type{
        margin-right: 1em;
    }
</style>

<script type="text/javascript">

var _isEdited = false;
$(document).ready(function () {
    $(':input').change(function () {
        _isEdited = true;
        if(this.id === 'to-search'){_isEdited = false;}
    });
    window.onbeforeunload = function (e) {
        if (_isEdited === true) {
        var e = e || window.event;
        // For IE and Firefox
        if (e) {
          e.returnValue = 'Des modifications ont été effectuées.';
        }
        // For Safari
        return 'Des modifications ont été effectuées.';
        };
    };
});
</script>
{%endblock%}
