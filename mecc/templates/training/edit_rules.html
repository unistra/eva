{% extends "base.html" %} {% load i18n %} {% load crispy_forms_tags %} {% load staticfiles %}
{% block page-header %}
<script src="{% static 'js/notif.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/notif.css' %}">
{% trans 'Fiche Formation' %}
{% endblock %}

{% block app_content %}
<div class='notifications top-right'></div>


<ul class="nav nav-tabs" style="margin-bottom:1em">
    <li><a href="{%if training%}{% url 'training:edit' training.pk%}{%else%}#{%endif%}">{% trans "Général" %}</a></li>
    <li class="active"><a href="{%if training%}{% url 'training:edit_rules' training.pk%}{%else%}#{%endif%}">{% trans "Règles" %}</a></li>
    <li><a href="#">{% trans "Tableau MECC" %}</a></li>
</ul>
<div class="disp-flex ">
    <div class="has-bottom-border parent disp-flex">
        <div class="item-80 dir-col">
            <div class="">
                {% trans "Intitulé de la formation: "%}
            </div>
            <div class="">
                <strong>{{training.label}}</strong>
            </div>
        </div>
        <div class="item-20 disabled dir-col">
            <div class="">
                {% trans "En service:"%} {%if training.is_used%} ☑ {%else%} ☐{%endif%}
            </div>
            <div class="">
                {% trans "Régime:"%} {{training.get_MECC_type_display}}
            </div>
            <div class="">
                {{training.get_session_type_display}}

            </div>
        </div>
    </div>
</div>
<div class="training-rules">
    <h2 class="title-block" style="font-weight: bold;">
        {% trans 'Règles générales applicables à cette formation'%}
    </h2>
    <div class="disp-flex">

    <div class="item-80" style="padding-bottom: 0px;margin-bottom: 0.2em;">
      {% if rules_list %}
      <table>
          <thead >
              <tr class="">
                  <div class="dir-row underlined ">
                      <div class="disp-flex" >
                          <div id='title-regle' class="centered"> {%trans "Règle standard" %}</div>
                          <div id='title-empty'class="border-left" style="border-left-width:2px"></div>
                      </div>
                      <div class="disp-flex  border-bottom">
                          <div id="title-status" class="centered" >{% trans "Statut" %}</div>
                          <div id="title-label" >{% trans "Libellé" %}</div>
                          <div id="title-spec" class="centered border-left" style="border-left-width:2px">{% trans "Spécificités pour la formation </br> (Dérogations et alinéas aditionnels)" %}</div>
                      </div>
                    </div>
                </tr>
          </thead>

       <tbody class="overflow" >
      {%for e in rules_list%}

      <tr class="hover-row">
         <td width="10%" class='no-padding border-bottom td-centered red' >{% if e.is_edited == "O" %} {% trans "Modifiée" %}{%elif e.is_edited == "N"%}{% else %}{{e.get_is_edited_display}}{% endif %}</td>
         <td width="52%" class="no-padding border-right border-bottom"><a class="select" onclick="detail_rule({{e.id}},'standard')">{{e.label}}</a></td>
         <td width="10%" class="no-padding td-centered border-bottom italic text-muted">{% if e.has_parag_with_derog  %}{% trans "(D)" %}{% endif %}</td>
         <td width="14%" class="no-padding td-centered border-bottom underlined">
            <a class="select" style='color:#333333' href="{% url 'training:specific_paragraph' training.id e.id%}">{% trans "Saisir" %}</a>
        </td>
        <td width="14%" class="no-padding border-bottom">
               {% if e.id in custom %}
               <a class="select" onclick="detail_rule({{e.id}}, 'specific')">{% trans "Voir" %}</a>
               {% endif %}
       </td>
      </tr>
      {% endfor %}
    </tbody>
    </table>
    {% endif %}
    </div>
    <div class="item-20 flex-center">
        <a href="#" class="break-line btn-primary btn " style="white-space: normal;margin:0.5em">{% trans "Récupérer TOUTES les spécificités de l'année précédente" %}</a>

    </div>
</div>
    <div class="has-bottom-border has-top-border buttons_list dir-col blue "  >
        <label>
            {% trans 'Etat de saisie des règles : '%}
        </label>
        <label class="margin-left1">
         {% trans "En cours " %}<input disabled type="radio" name="progress" value="E" {% if training.progress_rule == "E" %}checked="checked" {% endif %} style="margin-top:-1px;vertical-align:middle;">
     </label>
        <label class="margin-left1">
        {% trans 'Achevée '%} <input disabled type="radio" name="progress" value="A"  {% if training.progress_rule == "A" %}checked="checked" {% endif %}style="margin-top:-1px;vertical-align:middle;">
    </label>

    </div>
    <div class="buttons_list" >
<br>
    <a href="#" class="btn-primary btn btn-sm btn-1">{% trans "Récapitulatif des règles de la formation (avec spécificités)" %}</a>
    <a href="#" class="btn-primary btn btn-sm">{% trans "Effectuer les CONTRÔLES DE COHERENCE" %}</a>
    <a href="#" class="btn-primary btn btn-sm">{% trans "Envoyer un message à la DES" %}</a>
    </div>

</div>
    {% include "training/rule_preview.html"%}

    <style media="screen">

    table {

      height: 100%;
      width: 100%;
    }

    .overflow {
      /* body takes all the remaining available space */
      display: flex;
      flex-flow: column;

      flex: 1 1 auto;
      display: block;
      overflow: auto;
      max-height: 50vh;

    }

    </style>

    <script type="text/javascript">
    function correct_width(){
        var td1 = $('.overflow').find('tr').children('td:first');
        var td2 = td1.next();
        var td3 = td2.next();
        var td4 = td3.next();
        document.getElementById('title-regle').style.width = (td1.width() + td2.width()) + 'px';
        document.getElementById('title-status').style.width = td1.width() + 'px';
        document.getElementById('title-label').style.width = td2.width() + 'px';
        document.getElementById('title-spec').style.width = (td3.width() + td4.width()) + 'px';
    }
    $( '#menu-toggle' ).on('click', function() {
        setTimeout("correct_width()",900)

    });
    $(window ).on('resize', function() {
        setTimeout("correct_width()",900)
    });
    correct_width()

        function detail_rule(id, type){
            $.ajax({
                url: "{% url 'rules:details_rule'%}",
                type: "POST",
                data: {
                    val: id,
                    type: type,
                    training_id : {{training.id}},
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(data){
                       document.getElementById('year').innerHTML = data.year
                       document.getElementById('title-preview').innerHTML = data.title
                       document.getElementById('preview-rules').getElementsByTagName('tbody')[0].innerHTML = ''
                       document.getElementById('big-title-preview').innerHTML = "";

                       if (!data.is_specific) {
                           document.getElementById('subtitle-preview').innerHTML = "";
                           document.getElementById('big-title-preview').innerHTML = "{% trans 'Règle standard' %}";
                       } else {
                           document.getElementById('subtitle-preview').innerHTML = "{% trans 'FORMATION'%} : {{training.label}}";
                           document.getElementById('big-title-preview').innerHTML = "{% trans 'Règles avec dérogations (et alinéa additionnel)' %}";
                       }

                       for (i=0; i < data.paragraphs.length + 1; i++){
                           var tableRef = document.getElementById('preview-rules').getElementsByTagName('tbody')[0];
                           var newRow   = tableRef.insertRow(tableRef.rows.length);
                           newRow.style.marginTop = '1em';
                           newRow.style.marginBottom = '1em';
                           var cell0  = newRow.insertCell(0);
                           var cell1  = newRow.insertCell(1);
                           var cell2  = newRow.insertCell(2);
                           cell0.style.width = '10%';
                           cell0.style.textAlign = "center"
                           cell1.style.width = '70%';
                           cell2.style.width = '20%';
                           if (i === data.paragraphs.length){
                               if (data.additional != null) {
                                   newRow.className += 'green'
                                   cell0.innerHTML = data.additional.alinea;
                                   cell1.innerHTML = data.additional.text;
                                   cell2.style.padding = '0 0 0 2em';
                                   cell1.style.padding = '1em 0 0 0';
                                   cell2.innerHTML = '({% trans "Alinéa additionnel"%})'

                                }
                               break;
                           }
                           cell0.innerHTML = data.paragraphs[i].alinea;
                           cell1.innerHTML = data.paragraphs[i].text;
                           if (data.is_specific) {
                               cell2.style.padding = '0 0 0 2em';
                           };
                           if (data.paragraphs[i].is_derog === true){
                               if (data.is_specific === true) {
                                   cell1.className += 'blue ';
                                   cell2.style.padding = '0 0 0 2em;';
                                   cell2.innerHTML = '({% trans "Dérogation" %})';
                               } else {
                                   cell2.className += ' border-left disabled italic td-centered';
                                   cell2.innerHTML = '{% trans "Dérogation possible"%}'
                               }
                           }
                           if (data.is_specific & (!data.paragraphs[i].is_derog === true )) {
                               cell2.innerHTML = '({% trans "Standard" %})';

                           }
                       }
                   }
               });
               $('#preview').modal('show');

        }
    </script>
{%endblock%}
