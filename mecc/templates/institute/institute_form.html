{% extends 'base.html' %}

{% load i18n %}
{% load staticfiles %}
{% load crispy_forms_tags %}

{% block page-header %}

{% trans 'Fiche composante' %}
{% if object%}
<a href="{% url 'institute:delete' code=object.code %}" class="glyphicon glyphicon-trash"></a>
{% endif %}
{% endblock %}

{% block app_content %}

<link rel="stylesheet" href="{% static 'css/autocomplete.min.css' %}" type="text/css" title="no title" charset="utf-8" />
<script src="{% static 'js/autocomplete.js' %}"></script>
<div class='flex-container'>
<form action="" method="post" id='form-comp'>
<div id="div_auto_id">
  <label for="auto_id" class="control-label col-lg-5 requiredField">
                {% trans "ID composante" %} <small> {% trans "(auto)" %}</small><span class="asteriskField">*</span> </label>
<div class="controls col-lg-6"> <input class="textinput textInput form-control" id="id_code_auto" value={% if object%}"{{object.id}}"{%else%}"{{latest_instit_id}}" {% endif %}readonly=True type="text"> </div>
</div>
  <hr id="hr1">
  <hr id="hr2">
  <hr id="hr3">
  {% crispy form %}

    <input id="btn-add-composante"  comp-right-btn-close class="btn btn-primary btn-lines"
     type="submit" value="{% trans 'Valider et fermer la fiche' %}"
     onclick="_isDirty=false"/>
<div id='first'></div>
</form>
<div id="comp-right">

  <h3> {% trans "Année cible" %} {{dates.code_year}}/{{dates.code_year|add:'1'}}</h3>

  <div id="div_cadre_gen">
    <label for="cadre_gen" class="control-label col-lg-12">
        <u>{% trans 'Document Cadre général CFVU' %}</u> : <a href ='#'>{{cadre_gen}}</a></label>
  </div>

  <div>
    <label class="control-label col-lg-8">
      {% trans "Date validation cadre en CFVU" %}
    </label>
    <div class="controls col-lg-4">
      <input class=" form-control" value="{{dates.date_validation|date:'d/m/Y'}}" readonly="True">
    </div>
  </div>


<div>
  <label class="control-label col-lg-8">
    {% trans "Date prévisionnelle CFVU MECC" %}
  </label>
  <div class="controls col-lg-4">
    <input class=" form-control" value="{{dates.date_expected|date:'d/m/Y'}}" readonly="True">
  </div>
</div>

<div></br></div>

<div>
  <label class="control-label col-lg-8">
    {% trans "Date prévisionnelle Conseil comp. MECC" %}
  </label>
  <div class="controls col-lg-4">
    <input class=" form-control" value="{{dates.date_expected_MECC|date:'d/m/Y'}}" readonly="True">
  </div>
</div>
  <div>
    <label class="control-label col-lg-8">
      {% trans "Date dernière notification MECC" %}
    </label>
    <div class="controls col-lg-4">
      <input class=" form-control" value="{{dates.date_last_notif|date:'d/m/Y'}}" readonly="True">
    </div>
  </div>

  <div></br></div>

  <div>
    <label class="control-label col-lg-12">
      {% trans "Lettre de présentation" %}
    </label>
    <div class="controls col-lg-12">
      <input class=" form-control" value="{{current_year.pdf_doc}}" readonly="True">
    </div>
  </div>

  <div>
    <label class="control-label col-lg-12">
      {% trans "Autres documents" %}
    </label>
    <div class="controls col-lg-12">
      <input class=" form-control" value="{{current_year.pdf_doc}}" readonly="True">
    </div>
  </div>


 <a id="comp-right-btn-close" href="{% url 'institute:create' %}" class="btn btn-primary"> {% trans "Ajouter une composante" %}</a>

 <input id="input_prof_id_member" placeholder="Prof_id" />
 <input id="input_prof_last_name" placeholder="Prof_last_name" />
 <input id="input_prof_first_name" placeholder="Prof_first_name" />
 <input id="input_prof_mail" placeholder="Prof_mail" >
 <input id="input_prof_status" placeholder="Prof_status"/>

</br>
 <input id="input_adm_id_member" placeholder="adm_id" />
 <input id="input_adm_last_name" placeholder="adm_last_name" />
 <input id="input_adm_first_name" placeholder="adm_first_name" />
 <input id="input_adm_mail" placeholder="adm_mail" >
 <input id="input_adm_status" placeholder="adm_status"/>
 <script type="text/javascript">
 // Get cmp code in order to search people
code_cmp = document.getElementById("id_code").value
var url_prof = "/institute/ressources/prof/" + code_cmp + ".json"
var url_adm = "/institute/ressources/adm/" + code_cmp + ".json"
   var _isDirty = false;
   $(':input').change(function () {
     old_val = this.value;
     _isDirty = true;
     console.log(old_val);
   });


 $(document).ready(function () {


   window.onbeforeunload = function (e) {
   if (_isDirty === true) {
   var e = e || window.event;

   // For IE and Firefox
   if (e) {
     e.returnValue = 'Des modifications ont été effectuées.';
   }

   // For Safari
   return 'Des modifications ont été effectuées.';
 };
   };


$.getJSON(url_prof, function (data) {
 var options = {
   data: data,
   getValue: function (element) {
     return element.last_name + " " + element.first_name + " ";

   },
   template: {
		type: "description",
		fields: {
			description: "id_member"
		}
	},
   list: {
		showAnimation: {
			type: "slide", //normal|slide|fade
			time: 400,
			callback: function() {}
		},

		hideAnimation: {
			type: "slide", //normal|slide|fade
			time: 400,
			callback: function() {}
		},
   		match: {
   			enabled: true
   		},
      onSelectItemEvent: function() {
        var username = $(".input_prof").getSelectedItemData().id_member;
        var last_name = $(".input_prof").getSelectedItemData().last_name;
        var first_name = $(".input_prof").getSelectedItemData().first_name;
        var email = $(".input_prof").getSelectedItemData().mail;
        var status = $(".input_prof").getSelectedItemData().status;

        $("#input_prof_id_member").val(username).trigger("change");
        $("#input_prof_last_name").val(last_name).trigger("change");
        $("#input_prof_first_name").val(first_name).trigger("change");
        $("#input_prof_mail").val(email).trigger("change");
        $("#input_prof_status").val(status).trigger("change");
      },
   	}
  };
 $(".input_prof").easyAutocomplete(options);
 $(".input_prof").prop('readonly', false);

});




   $.getJSON(url_adm, function (data) {
    var options = {
      data: data,
      getValue: function (element) {
        return element.last_name + " " + element.first_name + " ";
      },
      template: {
        type: "description",
    		fields: {
    			description: "id_member"
   		}
   	},
       list: {
		showAnimation: {
			type: "slide", //normal|slide|fade
			time: 400,
			callback: function() {}
		},

		hideAnimation: {
			type: "slide", //normal|slide|fade
			time: 400,
			callback: function() {}
		},
      		match: {
      			enabled: true
      		},
         onSelectItemEvent: function() {
           var username = $(".input_adm").getSelectedItemData().id_member;
           var last_name = $(".input_adm").getSelectedItemData().last_name;
           var first_name = $(".input_adm").getSelectedItemData().first_name;
           var email = $(".input_adm").getSelectedItemData().mail;
           var status = $(".input_adm").getSelectedItemData().status;

           $("#input_adm_id_member").val(username).trigger("change");
           $("#input_adm_last_name").val(last_name).trigger("change");
           $("#input_adm_first_name").val(first_name).trigger("change");
           $("#input_adm_mail").val(email).trigger("change");
           $("#input_adm_status").val(status).trigger("change");      },
      	}
     };
    $(".input_adm").easyAutocomplete(options);
    $(".input_adm").prop('readonly', false);

   });




});

 </script>
</div>
</div>
<script>
// Add checkbox next to id_code
check_box = document.getElementById("div_id_is_on_duty");
id_code = document.getElementById("id_code").parentNode;
id_code.appendChild(check_box)

// ////////// ************ Let's do some AJAX
code_cmp = document.getElementById("id_code").value
var url_prof = "/institute/ressources/prof/" + code_cmp + ".json"
var url_adm = "/institute/ressources/adm/" + code_cmp + ".json"


</script>
{% endblock %}
