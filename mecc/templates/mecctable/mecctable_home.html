{% extends "base.html" %} {% load i18n %} {% load crispy_forms_tags %} {% load groups %} {% load staticfiles %}
{% block page-header %}
{% trans 'Fiche Formation' %} {% endblock %} {% block breadcrumb %}
<ol class="breadcrumb">
    {%if request.session.visited_cmp == "RESPFORM"%}
        <li><a href="{%url 'training:list_resp' %}">{% trans "Mes formations" %}</a></li>
    {%else%}
        <li><a href="{% if request.user|has_group:'DES1' or request.user.is_superuser %}{%url 'training:list_all'%}
            {% else %}{%url 'training:list' request.user.meccuser.cmp%}
            {%endif%}">{% trans "Offre de formation" %}</a></li>
            <li> <a href="{%url 'training:list' request.session.visited_cmp %}">{{request.session.visited_cmp_label}}</a></li>
        {% if request.session.training_list %}
        {% endif %}
    {%endif%}
        <li class="active"> {{training.label}}</li>
</ol>
{% endblock %} {% block app_content %}


<link rel="stylesheet" href="{% static 'css/mecctable-home.css' %}" type="text/css" title="no title" charset="utf-8" />

<script src="{% static 'js/notif.js' %}"></script>
<script src="{% static 'js/datatable.min.js' %}"></script>
<span class="top-right"></span>
<ul class="nav nav-tabs" style="margin-bottom:1em">
    <li><a href="{%if training%}{%url 'training:edit' training.pk%}{%else%}#{%endif%}">{% trans "Général" %}</a></li>
    <li><a href={%if training and not "CATALOGUE" in training.degree_type.long_label%}"{% url 'training:edit_rules' training.pk%}" {%else%}"#" class="disabled"{%endif%}>{% trans "Règles" %}</a></li>
    <li class="active"><a href="#">{% trans "Tableau MECC" %}</a></li>
</ul>
<div class="disp-flex dir-col has-bottom-border">
    <div class=" parent disp-flex ">
        <div class="item-80 dir-col">
            <div class="">
                {% trans "Intitulé de la formation: "%}
            </div>
            <div class="">
                <strong>{{training.label}}</strong>
            </div>
        </div>
        <div class="item-20 disabled dir-col">
            <div>
                {% trans "En service:"%} {%if training.is_used%} ☑ {%else%} ☐{%endif%}
            </div>
            <div>
                {% trans "Régime:"%} {{training.get_MECC_type_display}}
            </div>
            <div>
                {{training.get_session_type_display}}
            </div>
        </div>
    </div>
    <div>

        <div class="blue">
            {% trans "Racine" %}<br>
            <a onclick="get_struct_details(0,0, 'E')" data-toggle="modal" class="hand glyphicon glyphicon-plus blue no-border" aria-hidden="true" data-target="#form-obj" ></a>
            <span class="hand glyphicon glyphicon-circle-arrow-left no-border green" aria-hidden="true" data-toggle="modal" data-target="#shared-object" onclick="asking_inclusion=0;" ></span>
        </div>
        {% if la_liste|length > 0 %}
        <table id="mecc_table" width="100%">
            <thead>
                <tr>
                    <th></th>
                    <th colspan="5"></th>
                    <th colspan="5" class="centered border-bottom "></th>
                    <th colspan="4" class="centered border-bottom  ">{% trans "Session principale" %}</th>
                    <th colspan="4" class="centered border-bottom border-left-3">{% trans "Session de rattrapage" %}</th>
                </tr>
                <tr>
                    <th></th>
                    <th class="border-bottom "></th>
                    <th class="border-bottom "></th>
                    <th class="border-bottom "></th>
                    <th class="border-bottom "></th>
                    <th class="border-bottom "></th>
                    <th class="centered border-left border-bottom ">{% trans "ECTS" %}</th>
                    <th class="centered border-left border-bottom ">{% trans "Responsable" %}</th>
                    <th class="centered border-left-3 border-bottom ">{% trans "Coef" %}</th>
                    <th class="centered border-left-3 border-bottom ">{% trans "Note<br>seuil" %}</th>
                    <th class="centered border-left-5 border-bottom ">{% trans "" %}</th>
                    <th class="centered border-left border-bottom ">S1</th>
                    <th class="centered border-left border-bottom ">S2</th>
                    <th class="centered border-left border-bottom ">S3</th>
                    <th class="centered border-left border-bottom ">S4</th>
                    <th class="centered border-left-3 border-bottom ">S1</th>
                    <th class="centered border-left border-bottom ">S2</th>
                    <th class="centered border-left border-bottom ">S3</th>
                    <th class="centered border-left border-bottom ">S4</th>
                </tr>
            </thead>
            <tbody>
                {% for a in la_liste %}
                <tr class="hover-row len-{{a.link.rank}}  parent-{{a.link.id_parent}} order-{{a.link.order_in_child}} {%if not a.structure.is_in_use%}grey-all{%endif%} {%if a.is_imported%} green{%endif%}">
                    <td>
                        <div class="width-3 ">
                            <span class="glyphicon hand arrow-move glyphicon-arrow-down blue no-border" aria-hidden="true"></span>
                            <span class="glyphicon hand arrow-move glyphicon-arrow-up blue no-border" aria-hidden="true"></span>
                        </div>
                    </td>
                    <td class=" border-bottom" class="nowrap">
                        {% for i in a.loop  %}
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        {% endfor %}
                        {{a.structure.nature}} :
                        {%if a.is_imported%}
                            {{a.structure.label}}
                        {% else %}
                            <a data-toggle="modal" class="hand no-border" aria-hidden="true" data-target="#form-obj"
                            onclick="get_struct_details({{a.structure.id}}, {{a.link.id_parent}}, '{{a.link.nature_parent}}')">{{a.structure.label}}</a>
                        {%endif%}
                    </td>
                    <td class="centered border-bottom">
                        {% if a.structure.nature not in "ST PT" and not a.is_imported%}
                            <a onclick="get_struct_details(0, {{a.structure.id}},'{{a.structure.nature}}')"
                            data-toggle="modal" class="hand glyphicon glyphicon-plus blue no-border" aria-hidden="true"
                            data-target="#form-obj" ></a>
                    </td>
                    <td class="centered border-bottom">
                            <span data-toggle="modal" data-target="#shared-object"
                            class="glyphicon glyphicon-circle-arrow-left green hand"
                            onclick="asking_inclusion={{a.structure.id}};"></span>
                        {% else %}
                    </td>
                    <td class="centered border-bottom">
                        {%endif%}
                    </td>
                    <td class="centered border-bottom">
                        {% if a.link.is_imported %}
                            <span data-toggle="modal" class="glyphicon glyphicon glyphicon-remove-sign red hand"
                            onclick="ask_delete_imported({{a.link.id}}, '{{a.structure.label}}')" data-target="#preview"></span>
                        {% else %}
                            {% if a.is_imported == False and a.no_children %}
                                <span data-toggle="modal" class="glyphicon glyphicon glyphicon-remove-sign red hand"
                                onclick="ask_delete({{a.structure.id}}, '{{a.structure.label}}')" data-target="#preview"></span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td class="centered border-bottom">
                        {% if a.structure.mutual and not a.link.is_imported %}
                            <a onclick="get_consom({{a.structure.id}})" class="hand">{% trans "mut." %}</a>
                        {% endif %}
                    </td>
                    <td class="centered border-bottom">
                        {% if a.structure.nature == 'UE' %}{{a.structure.ECTS_credit}}{% endif %}
                    </td>
                    <td class="border-bottom">{{a.structure.get_respens_name}}
                        {% if a.structure.external_name %} <i>{{a.structure.external_name}}</i>{% endif %}
                    </td>
                    <td class="centered border-left-3 border-bottom editme"
                    {% if not a.is_imported %}contenteditable='true'{% endif %}
                    id="{{a.link.id}}-coeff">
                        {% if a.link.coefficient or a.link.coefficient == 0%}{{a.link.coefficient}}{% endif %}
                    </td>
                    <td class="centered border-left-3 border-bottom editme"
                    {% if not a.is_imported %}contenteditable='true'{% endif %}
                    id="{{a.link.id}}-grade">
                        {% if a.link.eliminatory_grade or a.link.eliminatory_grade == 0 %}{{a.link.eliminatory_grade}}{% endif %}
                    </td>
                    <td class="centered border-left-5 border-bottom"> ▶ </td>
                    <td class="centered border-left border-bottom"></td>
                    <td class="centered border-left border-bottom"></td>
                    <td class="centered border-left border-bottom"></td>
                    <td class="centered border-left border-bottom"></td>
                    <td class="centered border-left-3 border-bottom"></td>
                    <td class="centered border-left border-bottom"></td>
                    <td class="centered border-left border-bottom"></td>
                    <td class="centered border-left border-bottom"></td>

                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% endif %}

    </div>
    <div class="footer">
        <div class="has-bottom-border has-top-border buttons_list dir-col blue baseline">
            <label>
            {% trans 'Etat de saisie du tableau MECC : '%}
        </label>
            <label class="margin-left1">
         {% trans "En cours " %}<input type="radio" name="progress" value="E" {% if training.progress_table == "E" %}checked="checked" {% endif %}>
     </label>
            <label class="margin-left1">
        {% trans 'Achevée '%} <input type="radio" name="progress" value="A"  {% if training.progress_table == "A" %}checked="checked" {% endif %}>
    </label>
        </div>
        <div class="button_container dir-row">
            <div class="dir-col">

            </div>
            <div class="flex-item">
                <a href="#" class="btn-primary btn btn-sm btn-1 {% if object_link %}disabled white"{% endif %}">{% trans "Récupérer la STRUCTURE <br>de l'année précédente" %}</a>
            </div>
            <div class="flex-item">
                <a href="#" class="btn-primary btn btn-sm btn-1 ">{% trans "Récupérer TOUTES les ÉPREUVES <br>de l'année précédente" %}</a>
            </div>
            <div class="flex-item">
                <a href="#" class="btn-primary btn btn-sm btn-1 ">{% trans "Récupérer TOUTES les ÉPREUVES <br>de l'année précédente" %}</a>
            </div>
            <div class="flex-item">
                <a href="#" class="btn-primary btn btn-sm btn-1 ">{% trans "Pré-visualiser <br>le TABLEAU" %}</a>
            </div>
            <div class="flex-item dir-row">
                <a data-toggle="modal" class="btn-primary btn btn-sm send_mail" data-target="#send_mail">{% trans "Envoyer un <br>message à la DES" %}</a> {# {% include "training/send_mail.html"%}#}
                <span class="small-blue-txt">{% trans "Si vous souhaitez poser une question ou demander un avis sur les modalités d'évaluation, solliciter la DES" %}</span>
            </div>
        </div>
        {% include "mecctable/modal/structure_object_form.html" %}
        {% include "mecctable/modal/show_consume.html" %}
        {% include "mecctable/modal/include_shared_object.html" %}
        {% include "generic/modal_confirm_delete.html" %}
        {% include "generic/search_member.html" with type="RESPENS" style="un enseignant" %}

    </div>
</div>
<style media="screen">
    .small-blue-txt {
        color:rgb(0, 110, 174);
        font-size:0.7em;
        line-height:1;
    }
    .grey-all * {
        color: grey!important;
    }
    .button_container {
        display: -webkit-box;
        display: -moz-box;
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
        -webkit-flex-flow: row wrap;
        justify-content: space-between;;
        flex-wrap: wrap;
        width: 100%;
    }
    .flex-item {
        margin-top: 1em;
        width: 19%;
    }
    .flex-item >:first-child{
        width:100%;
        padding: 0.5em 1em 0.5em 1em;
    }
    #mecc_table {
        width: 100%;
    }
</style>
<script type="text/javascript">
$('.editme').on('keydown', function(e) {
    let that = this;
    if (e.which == 13 && e.shiftKey == false) {
        let value = this.innerHTML;
        $.ajax({
            url: "{%url 'mecctable:update_grade_coeff'%}",
            type: "POST",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                to_update: this.id,
                value : value
            },
            success: function(data) {
                if (data.status === "ERROR") {
                    alert(data.error);
                }
              that.innerHTML = data.val;
          }
      })
    return false;
  }
});

let asking_inclusion = 0;
function ask_delete(id_obj, label){
    document.getElementById('type').innerHTML = "cet objet (et ses enfants)";
    document.getElementById('to_del').innerHTML = label;
    document.gen_form.action = '/mecctable/structureobject/remove/' + id_obj;
}

function ask_delete_imported(id_link, label){
    document.getElementById('type').innerHTML = "cet objet importé";
    document.getElementById('to_del').innerHTML = label;
    document.gen_form.action = "/mecctable/imported/remove/" + id_link;
}


// In order to move row up and down
$('.arrow-move').click(function() {
    let row = $(this).closest('tr');
    let p_id = row.attr('class').split('parent-')[1].split(' ')[0];
    let row_prev = row.prev().attr('class');
    let row_next = row.next().attr('class');
    // UP
    if ($(this).hasClass('glyphicon-arrow-up')) {
        if (typeof row_prev !== 'undefined'){
            let same_up = get_same_up(row, p_id);
            if (same_up !== null) {
                same_up.before(row);
            } else {
                return;
            }
        } else {
            console.log("Ne peut pas monter ^^");
        }

    }
    // AND DOWN
    if ($(this).hasClass('glyphicon-arrow-down')) {
        if (typeof row_next !== 'undefined'){
            let same_down = get_same_down(row, p_id);
            if (same_down !== null) {
                same_down.after(row);
            } else {
                return;
            }
        } else {
            console.log("Ne peut pas decendre ^^");
        }
    }
});

function get_same_up(row, p_id){
    let row_prev = row.prev();
    if (typeof row_prev.attr('class') !== 'undefined'){
        if (row_prev.attr('class').split('parent-')[1].split(' ')[0] === p_id) {
            return row_prev;
        } else {
            return get_same_up(row_prev, p_id);
        }
    } else {
        return null;
    }
}

function get_same_down(row, p_id){
    let row_next = row.next();
    if (typeof row_next.attr('class') !== 'undefined'){
        if (row_next.attr('class').split('parent-')[1].split(' ')[0] === p_id) {
            return row_next;
        } else {
            return get_same_down(row_next, p_id);
        }
    } else {
        return null;
    }
}

</script>
{%endblock%}
